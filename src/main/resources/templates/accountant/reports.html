<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Отчетность - Бухгалтер</title>
</head>
<body th:replace="~{layout :: html(
    title='Формирование отчетности',
    icon='bi-file-earmark-text',
    actions=~{:: #actions},
    content=~{:: #content},
    scripts=~{:: #scripts}
)}">

<div id="actions">
    <div class="btn-group me-2">
        <a th:href="@{/accountant/reports/salary-excel(month=${month}, year=${year})}"
           class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </a>
        <a th:href="@{/accountant/reports/salary-statement-pdf(month=${month}, year=${year})}"
           class="btn btn-danger">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </a>
    </div>
</div>

<div id="content">
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" th:action="@{/accountant/reports}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Месяц</label>
                    <select class="form-select" name="month">
                        <option th:each="monthEntry : ${@monthUtil.getRussianMonthsMap()}"
                                th:value="${monthEntry.key}"
                                th:selected="${month == monthEntry.key}"
                                th:text="${monthEntry.value}">
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Год</label>
                    <select class="form-select" name="year">
                        <option th:each="y : ${#numbers.sequence(2023, 2026)}"
                                th:value="${y}"
                                th:selected="${year == y}"
                                th:text="${y}">
                        </option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Отдел (для ведомости)</label>
                    <select class="form-select" name="departmentId">
                        <option value="">Все отделы</option>
                        <option th:each="dept : ${departments}"
                                th:value="${dept.id}"
                                th:text="${dept.name}"
                                th:selected="${departmentId == dept.id}">
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100">
                        <i class="bi bi-filter"></i> Применить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge"></i> Расчетные листки (PDF)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Расчётные листки для сотрудников с детализацией начислений и удержаний.</p>

                    <div class="mb-3">
                        <label class="form-label">Выберите сотрудника:</label>
                        <select class="form-select" id="employeeSelect">
                            <option value="">Выберите сотрудника</option>
                            <option th:each="employee : ${employees}"
                                    th:value="${employee.id}"
                                    th:text="${employee.fullName + ' - ' + employee.department.name}">
                            </option>
                        </select>
                    </div>

                    <button class="btn btn-outline-primary w-100"
                            onclick="generatePayslip()"
                            disabled
                            id="payslipBtn">
                        <i class="bi bi-file-earmark-pdf"></i> Сформировать расчетный листок
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Зарплатные ведомости (PDF)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Сводные ведомости по подразделениям или всему предприятию с подписями.</p>

                    <div class="btn-group-vertical w-100">
                        <a th:href="@{/accountant/reports/salary-statement-pdf(month=${month}, year=${year})}"
                           class="btn btn-outline-success mb-2">
                            <i class="bi bi-file-earmark-pdf"></i> Ведомость по всем отделам
                        </a>
                        <a th:if="${departmentId != null}"
                           th:href="@{/accountant/reports/salary-statement-pdf(departmentId=${departmentId}, month=${month}, year=${year})}"
                           class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-pdf"></i> Ведомость по текущему отделу
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-table"></i> Excel отчеты
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Полные данные по заработной плате в формате Excel для дальнейшего анализа.</p>

                    <div class="btn-group-vertical w-100">
                        <a th:href="@{/accountant/reports/salary-excel(month=${month}, year=${year})}"
                           class="btn btn-outline-warning mb-2">
                            <i class="bi bi-file-earmark-excel"></i> Основной отчет
                        </a>
                        <a th:href="@{/accountant/reports/detailed-salary-excel(month=${month}, year=${year})}"
                           class="btn btn-outline-warning">
                            <i class="bi bi-file-earmark-excel"></i> Детальный отчет
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-building"></i> Отчеты по подразделениям
                    </h5>
                </div>
                <div class="card-body">

                    <div class="mb-3">
                        <label class="form-label">Выберите подразделение:</label>
                        <select class="form-select" id="departmentReportSelect">
                            <option value="">Все подразделения</option>
                            <option th:each="dept : ${departments}"
                                    th:value="${dept.id}"
                                    th:text="${dept.name}">
                            </option>
                        </select>
                    </div>

                    <div class="btn-group w-100">
                        <button class="btn btn-outline-info"
                                onclick="generateDepartmentPdf()"
                                disabled
                                id="departmentPdfBtn">
                            <i class="bi bi-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-outline-info"
                                onclick="generateDepartmentExcel()"
                                disabled
                                id="departmentExcelBtn">
                            <i class="bi bi-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Статистика за период
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 th:text="${statistics.totalEmployees}">0</h3>
                                    <p class="text-muted mb-0">Сотрудников</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 th:text="${#numbers.formatDecimal(statistics.totalAccrued, 1, 'POINT', 2, 'COMMA')} + ' руб.'">
                                        0 руб.</h3>
                                    <p class="text-muted mb-0">Всего начислено</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 th:text="${#numbers.formatDecimal(statistics.totalDeducted, 1, 'POINT', 2, 'COMMA')} + ' руб.'">
                                        0 руб.</h3>
                                    <p class="text-muted mb-0">Всего удержано</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h3 th:text="${#numbers.formatDecimal(statistics.totalNetSalary, 1, 'POINT', 2, 'COMMA')} + ' руб.'">
                                        0 руб.</h3>
                                    <p class="text-muted mb-0">К выплате</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-clock-history"></i> Недавно рассчитанные зарплаты
            </h5>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Сотрудник</th>
                    <th class="text-end">К выплате</th>
                    <th class="text-center">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="salary : ${recentSalaries}">
                    <td th:text="${salary.employee.fullName}"></td>
                    <td class="text-end"
                        th:text="${#numbers.formatDecimal(salary.netSalary, 1, 'POINT', 2, 'COMMA')} + ' руб.'"></td>
                    <td class="text-center">
                        <a th:href="@{/accountant/reports/payslip-pdf(employeeId=${salary.employee.id}, month=${month}, year=${year})}"
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download"></i> Листок
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            const employeeSelect = document.getElementById('employeeSelect');
            const payslipBtn = document.getElementById('payslipBtn');

            if (employeeSelect && payslipBtn) {
                employeeSelect.addEventListener('change', function () {
                    payslipBtn.disabled = !this.value;
                });
            }

            const departmentReportSelect = document.getElementById('departmentReportSelect');
            const departmentPdfBtn = document.getElementById('departmentPdfBtn');
            const departmentExcelBtn = document.getElementById('departmentExcelBtn');

            if (departmentReportSelect && departmentPdfBtn && departmentExcelBtn) {
                departmentReportSelect.addEventListener('change', function () {
                    const hasValue = !!this.value;
                    departmentPdfBtn.disabled = !hasValue;
                    departmentExcelBtn.disabled = !hasValue;
                });
            }
        });

        function generatePayslip() {
            const employeeId = document.getElementById('employeeSelect').value;
            const month = /*[[${month}]]*/ '';
            const year = /*[[${year}]]*/ '';

            if (employeeId) {
                const url = `/accountant/reports/payslip-pdf?employeeId=${employeeId}&month=${month}&year=${year}`;
                window.open(url, '_blank');
            }
        }

        function generateDepartmentPdf() {
            const departmentId = document.getElementById('departmentReportSelect').value;
            const month = /*[[${month}]]*/ '';
            const year = /*[[${year}]]*/ '';

            if (departmentId) {
                const url = `/accountant/reports/salary-statement-pdf?departmentId=${departmentId}&month=${month}&year=${year}`;
                window.open(url, '_blank');
            } else {
                const url = `/accountant/reports/salary-statement-pdf?month=${month}&year=${year}`;
                window.open(url, '_blank');
            }
        }

        function generateDepartmentExcel() {
            const departmentId = document.getElementById('departmentReportSelect').value;
            const month = /*[[${month}]]*/ '';
            const year = /*[[${year}]]*/ '';

            if (departmentId) {
                const url = `/accountant/reports/department-salary-excel?departmentId=${departmentId}&month=${month}&year=${year}`;
                window.open(url, '_blank');
            } else {
                const url = `/accountant/reports/salary-excel?month=${month}&year=${year}`;
                window.open(url, '_blank');
            }
        }

        /*]]>*/
    </script>
</div>
</body>
</html>