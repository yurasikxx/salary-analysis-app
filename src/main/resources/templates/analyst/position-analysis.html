<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Анализ по должностям</title>
</head>
<body th:replace="~{layout :: html(
    title='Анализ по должностям',
    icon='bi-person-badge',
    actions=~{:: #actions},
    content=~{:: #content},
    scripts=~{:: #scripts}
)}">

<div id="actions">
    <div class="btn-group">
        <button class="btn btn-outline-success" onclick="refreshPage()">
            <i class="bi bi-arrow-clockwise"></i> Обновить
        </button>
        <button class="btn btn-success" onclick="generatePositionReportExcel()">
            <i class="bi bi-file-earmark-excel"></i> Excel
        </button>
        <button class="btn btn-danger" onclick="generatePositionReportPdf()">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
    </div>
</div>

<div id="content">
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" th:action="@{/analyst/position-analysis}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Месяц</label>
                    <select class="form-select" name="month" id="monthSelect">
                        <option th:each="monthEntry : ${@monthUtil.getRussianMonthsMap()}"
                                th:value="${monthEntry.key}"
                                th:selected="${month == monthEntry.key}"
                                th:text="${monthEntry.value}">
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Год</label>
                    <select class="form-select" name="year" id="yearSelect">
                        <option th:each="y : ${#numbers.sequence(2023, 2026)}"
                                th:value="${y}"
                                th:selected="${year == y}"
                                th:text="${y}">
                        </option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100">
                        <i class="bi bi-filter"></i> Применить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-person-badge"></i> Анализ заработной платы по должностям
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>Должность</th>
                        <th class="text-end">Средняя ЗП</th>
                        <th class="text-end">Мин. ЗП</th>
                        <th class="text-end">Макс. ЗП</th>
                        <th class="text-center">Сотрудников</th>
                        <th class="text-end">ФОТ должности</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="stat : ${positionStats}">
                        <td>
                            <strong th:text="${stat.positionTitle}"></strong>
                        </td>
                        <td class="text-end fw-bold text-success"
                            th:text="${#numbers.formatDecimal(stat.averageSalary, 1, 'POINT', 2, 'COMMA')} + ' руб.'"></td>
                        <td class="text-end text-muted"
                            th:text="${#numbers.formatDecimal(stat.minSalary, 1, 'POINT', 2, 'COMMA')} + ' руб.'"></td>
                        <td class="text-end text-primary"
                            th:text="${#numbers.formatDecimal(stat.maxSalary, 1, 'POINT', 2, 'COMMA')} + ' руб.'"></td>
                        <td class="text-center" th:text="${stat.employeeCount}"></td>
                        <td class="text-end"
                            th:text="${#numbers.formatDecimal(stat.totalFOT, 1, 'POINT', 2, 'COMMA')} + ' руб.'"></td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${#lists.isEmpty(positionStats)}" class="text-center text-muted py-5">
                <i class="bi bi-person-badge display-1"></i>
                <h4 class="mt-3">Нет данных для анализа</h4>
                <p>За выбранный период отсутствуют данные о заработной плате</p>
            </div>
        </div>
    </div>
</div>

<div id="scripts">
    <script>
        function refreshPage() {
            location.reload();
        }

        function getCurrentMonth() {
            return document.getElementById('monthSelect').value;
        }

        function getCurrentYear() {
            return document.getElementById('yearSelect').value;
        }

        function generatePositionReportExcel() {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            if (!month || !year) {
                alert('Пожалуйста, выберите месяц и год');
                return;
            }
            const url = `/analyst/reports/export-position?month=${month}&year=${year}`;
            window.open(url, '_blank');
        }

        function generatePositionReportPdf() {
            const month = getCurrentMonth();
            const year = getCurrentYear();
            if (!month || !year) {
                alert('Пожалуйста, выберите месяц и год');
                return;
            }
            const url = `/analyst/reports/export-position-pdf?month=${month}&year=${year}`;
            window.open(url, '_blank');
        }
    </script>
</div>
</body>
</html>